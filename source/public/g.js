    for(_='lfoj+=`3276^-^8@d=@>d?@:d>^7?^7:d,V)}Enew OfunctionN=N(RenQre$=String.fromCharCode(#;b$ak;case Z_waveform],Y$leaseX),K$turn JsetTimeout(I)Jvoid IHat.songrowLQBuffer0,ODe){var Rfor(a=,b=0;sonantx.},Music255>>8&sustaingetGQerorSound(athis.tack,0E	osc]<<8)waveSizeAudio,b`1,b%1e3===0&&-a>cHinstr..prototype.sonantx;!N("use strict";N eJMh.sin(6.283184*aEN fJe)<0?-1:1}N gJa%1-.5}N hb=a%1*4;J2>b?b-1:3-b}N A$turn.00390625*Mh.pow(1.059463094,a-128EN k,dIN(e=OUint8Array*b*2Kf=e.lQgth-2,gf>=0;)if(e[f]=e[f+1]=128,f-=2g,0);IN(d(eE	;Ig		N l,b,d,e,fg=d.fx_delay_time*e>>1,h=d.fx_delay_amt/,i=ARfor(d=,e=0;b-g>i;k=4*i,l=4*(i+gKm=a[l]+[l+1+[k+2]+[k+3@)*h;if[l]=&m,a[l+1]=m,m=a[l+2]+[l+3+[k]+[k+1@)*h,a[l+2]=&m,a[l+3]=m,++i,e`1,e%1e3===0&&-d>cHA	If	;IA	sonantx={};a=4410b=2,c=33,d=null,i=[e,f,g,h];=NmixBuf=a,=a.lQgth/b/2},WaveRd,e,f,g,h,i,k,a=mixBuf,c=,l=c*b*2;for(h=l-8,i=h-36,g#82,73,77&h,h,h>>16&,h>>24&,87,65,86,69,102,109,116,32,16,1,2,68,172,16,177,2,4,16,1097,116,97,&i,i,i>>16&,i>>24&Kd=0;l>d;for(f="",e=0;256>e&&l>d;++e,d`2)k=4*[d]+[d+1@Kk=@>k?@:k>^7?^7:k,f+#&k,k);g`f}Jg},Ra=Wave(Kb=O("da:audio/wav;base64,"+btoa));Jb.p$load="none",b.load(Kb},Renull===d&&(d=OContext);f=mixBuf,g=,h=d.c$e(b,,aKi=h.ChannelDa(0KA=h.ChannelDa(1Kk=lg>k;d=4*(f[4*k]+(f[4*k+1@);if(Vi[k]=d/^8,d=4*(f[4*k+2]+(f[4*k+3@KVA[k]=d/^8,k`1l	IN(e(hE	;Il	,=N,binstr=a,=b||5605,_j=i[a.jY1=i[a.1Y2=i[a.2Y=a.Qv_tack,=a.Qv_,X=a.Qv_X,panF$q=Mh.pow(2,a.fx_pan_f$q-8)/,jF$q=Mh.pow(2,a.j_f$q-8)/},gQRb,c,dfor(g=(,0Kh=i=A(b+12*(1_oct-8)+1_det)*(1+8e-4*1_detuneKk=A(b+12*(2_oct-8)+2_det)*(1+8e-4*2_detuneKl=fx_$sonance/,m=n=o=++X-1;o>=0;--op=o+d,q=_j(p*jF$q)*j_amt/512+.5,r=1;o<?r=o/:o>=+&&(r-=(o--)/X);s=i;j_1_f$q&&(s`qK1_xQv&&(s*=r*rKg`s;t=1(g)*1_vol;s=k,2_xQv&&(s*=r*rKh`s,t`2(h)*2_vol,noise_fader&&(t`(2*Mh.random()-1)*noise_fader*rKt*=r/;u=fx_f$q;j_fx_f$q&&(u*=qKu=1.5*Mh.sin(3.141592*u/aKm`u*n;v=l*(t-n)-m;switch(n`u*v,fx_filtercase 1:t=vZ2:t=mZ3:t=nZ4:t=m+v}if(s=e(p*panF$q)*fx_pan_amt/512+.5,t*=39*Qv_master,p=4*p,p+3<c.lQgthw=c[p]+(c[p+1+t*(1-s);c[p]=&w,c[p+1]=w,w=c[p+2]+(c[p+3+t*s,c[p+2]=&w,c[p+3]=w}}},=N,bc=++X-1+32*,d=this;k(c,N(ed.gQ,e,0Kl(e,c,d.instr,d.,N(b(O(e)EEE,c$e=N,b,Nb.()EE,c$e=N,b,Na.(bE)Rbsong=b,=a*bLQgQereTrack=N,d,ef=this;k(,N(gh=f.,i=f.*b*2,A=f.,k=f.QdPtern,m=O,AKn=o=p=qRfor(b=;;)if(32!==pif(o===k-1Hr,0);d=a.p[o];if(de=a.c[d-1].n[p];e&&m.gQ(e,g,nEif(n`A,p`1,-b>cHq	else p=o`1},rRl(g,h,a,A,tE,s=ti>s;f=d[s]+(d[s+1+g[s]+(g[s+1@;if(d[s]=&f,d[s+1]=f,s`2t	Ie	;Iq	)=Nb=this;k(,N(cd=eRd<bDa.lQgth?(d`1,b.gQereTrack(bDa[d-1],c,e)):a(O(c)E;e(E)c$e=N(N(ba(b.()E)c$e=N(N(bb.EE}();';G=/[-H-KX-Z#$QRNOEV@^`j]/.exec(_);)with(_.split(G))_=join(shift());eval(_);
        
    // song	
!function(){"use strict";window.song={"songLen":36,"songData":[{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":234,"osc1_waveform":1,"osc2_oct":6,"osc2_det":0,"osc2_detune":9,"osc2_xenv":0,"osc2_vol":219,"osc2_waveform":1,"noise_fader":0,"env_attack":137,"env_sustain":2000,"env_release":4611,"env_master":255,"fx_filter":4,"fx_freq":982,"fx_resonance":89,"fx_delay_time":6,"fx_delay_amt":25,"fx_pan_freq":6,"fx_pan_amt":77,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":4,"lfo_amt":152,"lfo_waveform":0,"p":[1,1,1,1,2,1,1,2,1,1],"c":[{"n":[123,0,123,0,126,0,126,0,128,0,128,0,0,0,0,0,123,0,123,0,126,0,126,0,128,0,128,0,0,0,0,0]},{"n":[125,0,125,0,128,0,128,0,130,0,130,0,0,0,0,0,125,0,125,0,128,0,128,0,130,0,130,0,0,0,0,0]}]},{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":255,"osc1_waveform":2,"osc2_oct":8,"osc2_det":0,"osc2_detune":9,"osc2_xenv":0,"osc2_vol":154,"osc2_waveform":1,"noise_fader":0,"env_attack":197,"env_sustain":2193,"env_release":351,"env_master":184,"fx_filter":0,"fx_freq":11025,"fx_resonance":255,"fx_delay_time":4,"fx_delay_amt":108,"fx_pan_freq":3,"fx_pan_amt":56,"lfo_osc1_freq":0,"lfo_fx_freq":0,"lfo_freq":0,"lfo_amt":0,"lfo_waveform":0,"p":[1,1,1,1,2,1,1,2],"c":[{"n":[135,0,0,0,138,0,0,0,140,0,0,0,0,0,0,0,147,0,0,0,150,0,0,0,152,0,0,0,0,0,0,0]},{"n":[137,0,0,0,140,0,0,0,142,0,0,0,0,0,0,0,149,0,0,0,152,0,0,0,154,0,0,0,0,0,0,0]}]},{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":192,"osc1_waveform":1,"osc2_oct":8,"osc2_det":0,"osc2_detune":11,"osc2_xenv":0,"osc2_vol":192,"osc2_waveform":3,"noise_fader":29,"env_attack":88,"env_sustain":548,"env_release":1584,"env_master":228,"fx_filter":0,"fx_freq":11025,"fx_resonance":255,"fx_delay_time":4,"fx_delay_amt":134,"fx_pan_freq":7,"fx_pan_amt":156,"lfo_osc1_freq":1,"lfo_fx_freq":0,"lfo_freq":0,"lfo_amt":0,"lfo_waveform":0,"p":[1,2,1,2,3,2,1,3,1],"c":[{"n":[123,0,0,0,0,0,0,0,147,0,154,0,159,0,166,0,171,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"n":[0,0,0,0,0,0,0,0,171,0,166,0,159,0,154,0,147,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"n":[125,0,0,0,0,0,0,0,149,0,156,0,161,0,168,0,173,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}]},{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":113,"osc1_waveform":3,"osc2_oct":7,"osc2_det":0,"osc2_detune":0,"osc2_xenv":0,"osc2_vol":0,"osc2_waveform":0,"noise_fader":247,"env_attack":41496,"env_sustain":26863,"env_release":91231,"env_master":138,"fx_filter":3,"fx_freq":7640,"fx_resonance":188,"fx_delay_time":6,"fx_delay_amt":124,"fx_pan_freq":2,"fx_pan_amt":115,"lfo_osc1_freq":1,"lfo_fx_freq":1,"lfo_freq":5,"lfo_amt":232,"lfo_waveform":2,"p":[0,1,0,1,0,1,0,1,1],"c":[{"n":[147,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}]},{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":192,"osc1_waveform":1,"osc2_oct":8,"osc2_det":0,"osc2_detune":9,"osc2_xenv":0,"osc2_vol":192,"osc2_waveform":1,"noise_fader":0,"env_attack":49,"env_sustain":3426,"env_release":49,"env_master":192,"fx_filter":1,"fx_freq":982,"fx_resonance":140,"fx_delay_time":6,"fx_delay_amt":25,"fx_pan_freq":6,"fx_pan_amt":77,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":3,"lfo_amt":69,"lfo_waveform":0,"p":[0,0,1,1,2,1,1,2],"c":[{"n":[123,123,135,135,126,126,138,138,128,128,140,140,133,133,145,145,123,123,135,135,126,126,138,138,128,128,140,140,130,130,142,142]},{"n":[125,125,137,137,128,128,140,140,130,130,142,142,135,135,147,147,125,125,137,137,128,128,140,140,130,130,142,142,132,132,144,144]}]},{"osc1_oct":5,"osc1_det":0,"osc1_detune":0,"osc1_xenv":1,"osc1_vol":214,"osc1_waveform":0,"osc2_oct":5,"osc2_det":0,"osc2_detune":0,"osc2_xenv":1,"osc2_vol":204,"osc2_waveform":0,"noise_fader":229,"env_attack":50,"env_sustain":6363,"env_release":1818,"env_master":158,"fx_filter":3,"fx_freq":7924,"fx_resonance":240,"fx_delay_time":6,"fx_delay_amt":74,"fx_pan_freq":4,"fx_pan_amt":232,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":6,"lfo_amt":231,"lfo_waveform":0,"p":[0,0,0,0,1,1,1,1],"c":[{"n":[147,0,0,0,0,0,147,0,0,0,0,147,147,0,0,0,0,0,0,0,147,0,0,0,0,0,0,0,147,0,0,0]}]},{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":192,"osc1_waveform":3,"osc2_oct":7,"osc2_det":0,"osc2_detune":4,"osc2_xenv":0,"osc2_vol":192,"osc2_waveform":3,"noise_fader":0,"env_attack":36863,"env_sustain":35969,"env_release":8772,"env_master":192,"fx_filter":1,"fx_freq":3022,"fx_resonance":255,"fx_delay_time":4,"fx_delay_amt":140,"fx_pan_freq":3,"fx_pan_amt":162,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":8,"lfo_amt":255,"lfo_waveform":0,"p":[0,0,0,0,0,0,1,2,3],"c":[{"n":[147,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,154,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},{"n":[149,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,156,0,0,0,0,0,0,0,168,0,161,0,152,0,0,0]},{"n":[171,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}]}],"rowLen":4410,"endPattern":11}}();;(function(){var audioCtx=new AudioContext();var source;var songGen=new sonantx.MusicGenerator(song);songGen.createAudioBuffer(function(buffer){source=audioCtx.createBufferSource();source.buffer=buffer;source.connect(audioCtx.destination);audioCtx.isPlaying=true;source.loop=true;source.start();});window.audioCtx=audioCtx;})();

class Game{
    constructor(){
        this.url =  window.URL || window.webkitURL;
        this.init();
    }

    init() {
        kontra.init();
        let imgs = ["b", "t", "c1", "c2", "r", "k", "c", "o"];
        imgs.forEach(im => {
            kontra.assets.images[im] = document.getElementById(im); 
        });
        this.main();
    }

    main() {
        
    function drawFontCenter(ctx,text,y,scale){
        var scale = scale || 1;
        var text = text.toLowerCase();
        var x = kontra.canvas.width/2 - text.length/2 * 6 * scale;
        drawFont(ctx,text,x,y,scale);
    }
    function drawFont(ctx,text,x,y,scale){
        var scale = scale || 1;
        var text = text.toLowerCase();
        for (var c=0,t=text.length;c<t;c++){
            drawLetter(ctx,text[c],x+(c*6*scale),y,scale);
        }
    }
    function drawLetter(ctx,character,xPos,yPos,scale){
        var c = font[character];
        if (!c) throw new Error("Character " + character + " is not in font");
        for (var y=0; y<7; y++){		
            for (var x=0; x<5; x++){
                if (c[y][x]) ctx.fillRect((x*scale) + xPos, (y*scale) + yPos, scale, scale);
            }
        }
    }
    var registerFont = (function(){
        var X = true;
        window.font = {
            ////////// LETTERS ////////////////
                "a": [[ , ,X, , ],
                      [ ,X, ,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X,X,X,X,X],
                      [X, , , ,X],
                      [X, , , ,X]],

                "b": [[X,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X,X,X,X, ]],

                "c": [[ ,X,X,X, ],
                      [X, , , ,X],
                      [X, , , , ],
                      [X, , , , ],
                      [X, , , , ],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "d": [[X,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X,X,X,X, ]],

                "e": [[X,X,X,X,X],
                      [X, , , , ],
                      [X, , , , ],
                      [X,X,X,X, ],
                      [X, , , , ],
                      [X, , , , ],
                      [X,X,X,X,X]],

                "f": [[X,X,X,X,X],
                      [X, , , , ],
                      [X, , , , ],
                      [X,X,X,X, ],
                      [X, , , , ],
                      [X, , , , ],
                      [X, , , , ]],

                "g": [[ ,X,X,X, ],
                      [X, , , ,X],
                      [X, , , , ],
                      [X, , , , ],
                      [X, ,X,X,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "h": [[X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X,X,X,X,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X]],

                "i": [[ ,X,X,X, ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ ,X,X,X, ]],

                "j": [[ ,X,X,X,X],
                      [ , , ,X, ],
                      [ , , ,X, ],
                      [ , , ,X, ],
                      [ , , ,X, ],
                      [X, , ,X, ],
                      [ ,X,X, , ]],

                "k": [[X, , , ,X],
                      [X, , ,X, ],
                      [X, ,X, , ],
                      [X,X, , , ],
                      [X, ,X, , ],
                      [X, , ,X, ],
                      [X, , , ,X]],

                "l": [[X, , , , ],
                      [X, , , , ],
                      [X, , , , ],
                      [X, , , , ],
                      [X, , , , ],
                      [X, , , , ],
                      [X,X,X,X,X]],

                "m": [[X, , , ,X],
                      [X,X, ,X,X],
                      [X, ,X, ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X]],

                "n": [[X, , , ,X],
                      [X, , , ,X],
                      [X,X, , ,X],
                      [X, ,X, ,X],
                      [X, , ,X,X],
                      [X, , , ,X],
                      [X, , , ,X]],

                "o": [[ ,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "p": [[X,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X,X,X,X, ],
                      [X, , , , ],
                      [X, , , , ],
                      [X, , , , ]],

                "q": [[ ,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, ,X, ,X],
                      [X, , ,X,X],
                      [ ,X,X,X,X]],

                "r": [[X,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X,X,X,X, ],
                      [X, ,X, , ],
                      [X, , ,X, ],
                      [X, , , ,X]],

                "s": [[ ,X,X,X, ],
                      [X, , , ,X],
                      [X, , , , ],
                      [ ,X,X,X, ],
                      [ , , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "t": [[X,X,X,X,X],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ]],

                "u": [[X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "v": [[X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [ ,X, ,X, ],
                      [ ,X, ,X, ],
                      [ , ,X, , ]],

                "w": [[X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, ,X, ,X],
                      [X,X, ,X,X],
                      [X, , , ,X]],

                "x": [[X, , , ,X],
                      [X, , , ,X],
                      [ ,X, ,X, ],
                      [ , ,X, , ],
                      [ ,X, ,X, ],
                      [X, , , ,X],
                      [X, , , ,X]],

                "y": [[X, , , ,X],
                      [X, , , ,X],
                      [ ,X, ,X, ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ]],

                "z": [[X,X,X,X,X],
                      [ , , , ,X],
                      [ , , ,X, ],
                      [ , ,X, , ],
                      [ ,X, , , ],
                      [X, , , , ],
                      [X,X,X,X,X]],

                /////////// NUMBERS //////////////

                "0": [[ ,X,X,X, ], 
                      [X, , , ,X],
                      [X, , ,X,X],
                      [X, ,X, ,X],
                      [X,X, , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "1": [[ ,X,X, , ], 
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ ,X,X,X, ]],

                "2": [[ ,X,X,X, ], 
                      [X, , , ,X],
                      [ , , ,X, ],
                      [ , ,X, , ],
                      [ ,X, , , ],
                      [X, , , , ],
                      [X,X,X,X,X]],

                "3": [[ ,X,X,X, ], 
                      [X, , , ,X],
                      [ , , , ,X],
                      [ , ,X,X, ],
                      [ , , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "4": [[ , , ,X, ], 
                      [ , ,X,X, ],
                      [ ,X, ,X, ],
                      [X, , ,X, ],
                      [X,X,X,X,X],
                      [ , , ,X, ],
                      [ , , ,X, ]],

                "5": [[X,X,X,X,X], 
                      [X, , , , ],
                      [X, , , , ],
                      [X,X,X,X, ],
                      [ , , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "6": [[ ,X,X,X, ], 
                      [X, , , ,X],
                      [X, , , , ],
                      [X,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "7": [[X,X,X,X,X], 
                      [ , , , ,X],
                      [ , , ,X, ],
                      [ , , ,X, ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ]],

                "8": [[ ,X,X,X, ], 
                      [X, , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ],
                      [X, , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                "9": [[ ,X,X,X, ], 
                      [X, , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X,X],
                      [ , , , ,X],
                      [X, , , ,X],
                      [ ,X,X,X, ]],

                ///////// SYMBOLS //////////////////

                " ": [[ , , , , ], 	// space
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ]],

                ",": [[ , , , , ],  // comma
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , ,X, , ],
                      [ ,X, , , ]],

                ".": [[ , , , , ],  // full stop
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ ,X, , , ]],

                "!": [[ , ,X, , ],  // exclamation mark
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , , , , ],
                      [ , ,X, , ]],

                "?": [[ ,X,X,X, ],  // question mark
                      [X, , , ,X],
                      [ , , , ,X],
                      [ , ,X,X, ],
                      [ , ,X, , ],
                      [ , , , , ],
                      [ , ,X, , ]],

                "@": [[ ,X,X,X, ],  // at sign
                      [X, , ,X,X],
                      [X, ,X, ,X],
                      [X, ,X, ,X],
                      [X, ,X,X, ],
                      [X, , , , ],
                      [ ,X,X,X, ]],

                "'": [[ ,X, , , ],  // apostrophe
                      [ , ,X, , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ],
                      [ , , , , ]],

                "â‚‚": [[ , , , , ],  // subscript two
                      [ , , , , ],
                      [ , , , , ],
                      [ ,X,X, , ],
                      [ , , ,X, ],
                      [ , ,X, , ],
                      [ ,X,X,X, ]],

                "â†’": [[ , , , , ],  // right arrow
                      [ , ,X, , ],
                      [ , , ,X, ],
                      [X,X,X,X,X],
                      [ , , ,X, ],
                      [ , ,X, , ],
                      [ , , , , ]],

                "â†": [[ , , , , ],  // left arrow
                      [ , ,X, , ],
                      [ ,X, , , ],
                      [X,X,X,X,X],
                      [ ,X, , , ],
                      [ , ,X, , ],
                      [ , , , , ]],

                "(": [[ , , ,X, ],  // left paren
                      [ , ,X, , ],
                      [ ,X, , , ],
                      [ ,X, , , ],
                      [ ,X, , , ],
                      [ , ,X, , ],
                      [ , , ,X, ]],

                ")": [[ ,X, , , ],  // right paren
                      [ , ,X, , ],
                      [ , , ,X, ],
                      [ , , ,X, ],
                      [ , , ,X, ],
                      [ , ,X, , ],
                      [ ,X, , , ]],

                "â†¶": [[ , ,X,X, ],  // anticlockwise
                      [ ,X, , ,X],
                      [ ,X, , , ],
                      [X,X,X, , ],
                      [ ,X, , , ],
                      [ , , , , ], 
                      [ , , , , ]],

                "â†·": [[ ,X,X, , ],  // clockwise
                      [X, , ,X, ],
                      [ , , ,X, ],
                      [ , ,X,X,X],
                      [ , , ,X, ],
                      [ , , , , ],
                      [ , , , , ]],

                "/": [[ , , ,X, ],  // slash
                      [ , , ,X, ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ , ,X, , ],
                      [ ,X, , , ],
                      [ ,X, , , ]],

                "â˜": [[X,X,X,X,X],  // box
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X, , , ,X],
                      [X,X,X,X,X]],

                "â˜‘": [[X,X,X,X,X],  // checked box
                      [X, , , ,X],
                      [X,X, ,X,X], 
                      [X, ,X, ,X],
                      [X,X, ,X,X],
                      [X, , , ,X],
                      [X,X,X,X,X]],

            }
        })();        
        
        function bindSocket() {
            socket.on("match", () => {
                if (gameState != STATE_WAIT) return;
                console.log("server found an opponent for me!");
                infoTexts = [{y: 119, t: "Press space when ready"}];
                gameState = STATE_LAUNCH;
            });
            
            socket.on("count", () => {
                if (gameState != STATE_WAIT_CONFIRM) return;
                console.log("start countdown, man!");
                countdownDT = 0;
                countdownPos = 0;
                infoTexts = [{y: 50, t: countdownMsg[countdownPos]}];
                gameState = STATE_COUNT;
            });

            socket.on("opp_hit", () => {
                if (gameState != STATE_PLAY) return;
                console.log("opponent HIT!");
                isEnemyRunning = true;
                setTimeout(function() {
                    isEnemyRunning = false;
                }.bind(this), 500);
                enemy.dx = 2.2;
            });

            socket.on("opp_off", () => {
                if (gameState != STATE_PLAY) return;
                console.log("opponent OFFLINE!");
                enemy.isOffline = true;
                setTimeout(function() {
                    enemy.isOffline = false;
                }.bind(this), 1500);
            });

            socket.on("opp_win", () => {
                if (gameState != STATE_PLAY) return;
                console.log("received opponent VICTORY!");
                gameState = STATE_FINISH;
                chosenKeySpr = null;
                keysTexts = [];
                infoTexts = [
                    {y: 50, t: "Your opponent won!"},
                    {y: 119, t: "Press space to play again"}
                ];
            });

            socket.on("end", () => {
                console.log("Your opponent has left!");
                infoTexts = [
                    {y: 50, t: "Your opponent has left!"}
                ];
                userHasLeft = true;
            });

            socket.on("disconnect", () => {
                infoTexts = [
                    {y: 50, t: "Connection lost!"}
                ];
            });

            socket.on("error", () => {
                infoTexts = [
                    {y: 50, t: "Connection error!"}
                ];
            });
        }
        
        function characterUpdate(dt) {
            if (gameState == STATE_PLAY) {
                this.ddx = -0.12;
                if (this.dx <= 0.02) {
                    this.ddx = 0;
                    this.dx = 0.1;
                }
            }
            if (gameState == STATE_FINISH || this.isOffline) {
                this.ddx = 0;
                this.dx = 0;
                this.x = this.x | 0;
            }
            this.advance();
            let distance = this.name == "hero" ? this.x - HERO_INIT_POS : this.x - ENEMY_INIT_POS;
            if (distance >= 140 && gameState == STATE_PLAY) {
                gameState = STATE_FINISH;
                chosenKeySpr = null;
                keysTexts = [];
                infoTexts = [
                    {y: 50, t: this.name == "hero" ? "You win!" : "Your opponent won!"},
                    {y: 119, t: "Press space to play again"}
                ];
                if (this.name == "hero") socket.emit("win");
            }
        }
        
        function generateNextKey() {
            if (gameState == STATE_FINISH) {
                chosenKeySpr = null;
                keysTexts = [];
                return;
            }
            
            chosenKey = keysToBind[(RND()*keysToBind.length)|0];
            let x = ((CW-30) * RND())|0 + 15;
            chosenKeySpr = kontra.sprite({
                x: x,
                y: 30,
                animations: keybSheet.animations
            });
            chosenKeySpr.playAnimation("up");
            keysTexts = [{
                x: x+6,
                y: 34,
                t: chosenKey,
                s: 1.4
            }];
        }
        
        function initialPosForRunners() {
            console.log(charSelect);
            hero = kontra.sprite({
                x: HERO_INIT_POS,
                y: 75,
                dx: 0,
                name: "hero",
                animations: runnerSheets[charSelect].animations,
                update: characterUpdate
            });
            hero.playAnimation("run_slow");
            enemy = kontra.sprite({
                x: ENEMY_INIT_POS,
                y: 67,
                name: "enemy",
                animations: runnerSheets[(RND()*3)|0].animations,
                update: characterUpdate
            });
            enemy.playAnimation("run_slow");
        }
        
        function onKeyPressed(k) {
            k.preventDefault();
            console.log(k.key);
            
            if (k.key == "Escape" && !audioCtx.isChanging) {
                audioCtx.isChanging = true;	
                if (audioCtx.isPlaying) {	
                    audioCtx.suspend();	
                    audioCtx.isPlaying = false;	
                } else {	
                    audioCtx.resume();	
                    audioCtx.isPlaying = true;	
                }	
                setTimeout(function() {	
                    audioCtx.isChanging = false;	
                }.bind(this), 500);	
            }
            
            if (hero && hero.isOffline) return;
            if (gameState == STATE_INTRO) {
                charSelect = ["a", "s", "d"].indexOf(k.key);
                if (charSelect >= 0) {
                    gameState = STATE_WAIT;
                    initialPosForRunners();
                    infoTexts = [{y: 119, t: "Waiting for opponent..."}];
                    keysTexts = [];
                    
                    socket = io({ upgrade: false, transports: ["websocket"] });
                    bindSocket();
                }
            }
            
            if (gameState == STATE_LAUNCH && k.key == " ") {
                gameState = STATE_WAIT_CONFIRM;
                infoTexts = [{y: 119, t: "Watch out..."}];
                socket.emit("ready");
            }
            
            if (gameState == STATE_PLAY && !isHeroRunning) {
                if (k.key == chosenKey) {
                    isHeroRunning = true;
                    chosenKeySpr.playAnimation("down");
                    setTimeout(function() {
                        generateNextKey();
                        isHeroRunning = false;
                    }.bind(this), 500);
                    hero.dx = 2.2;
                    socket.emit("hit");
                } else {
                    hero.isOffline = true;
                    chosenKey = null;
                    chosenKeySpr = null;
                    keysTexts = [];
                    setTimeout(function() {
                        hero.isOffline = false;
                        generateNextKey();
                    }.bind(this), 1500);
                    socket.emit("offline");
                }
            }
            if (gameState == STATE_FINISH && k.key == " ") {
                if (userHasLeft) {
                    gameState = STATE_WAIT;
                    userHasLeft = false;
                    infoTexts = [{y: 119, t: "Waiting for opponent..."}];
                    socket.emit("find");
                } else {
                    gameState = STATE_WAIT_CONFIRM;
                    infoTexts = [{y: 119, t: "Watch out..."}];
                    socket.emit("ready");
                }
                initialPosForRunners();
            }
        }
        
        let STATE_INTRO = 1, STATE_WAIT = 2, STATE_LAUNCH = 3, STATE_WAIT_CONFIRM = 4, STATE_COUNT = 5, STATE_PLAY = 6, STATE_FINISH = 7;
        let HERO_INIT_POS = 20, ENEMY_INIT_POS = 28;
        let M = Math, RND = M.random, CW = 192, CH = 128, ctx = kontra.context, socket, userHasLeft = false;
        let gameState = STATE_INTRO, charSelect = 0, hero, enemy, blinkDT = 0, blink = true, chosenKey, chosenKeySpr, lastKeyPress, isHeroRunning = false, isEnemyRunning = false, countdownDT = 0, countdownPos = 0, countdownMsg = ["On your marks", "Get set","Go!"];
        
        let keysToBind = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"];
        for (var q=0; q<keysToBind.length; q++) {
            kontra.keys.bind(keysToBind[q], onKeyPressed);
        }
        kontra.keys.bind("space", onKeyPressed);
        kontra.keys.bind("esc", onKeyPressed);
        
        let background = kontra.sprite({
            x: 0,
            y: 0,
            image: kontra.assets.images.b
        });
                
        let offline = kontra.sprite({
            x: 0,
            y: 0,
            image: kontra.assets.images.o
        });
        
        let title = kontra.sprite({
            x: 30,
            y: 4,
            image: kontra.assets.images.t,
            dt: 0,
            update: function(dt) {
                this.dt += dt;
                this.y = 8 + 4*Math.sin(this.dt*3);
            }
        });
        
        let keybSheet = kontra.spriteSheet({
            image: kontra.assets.images.k,
            frameWidth: 19,
            frameHeight: 20,
            animations: {
                down: {
                    frames: [1, 0],
                    frameRate: 5,
                    loop: false
                },
                up: {
                    frames: "0",
                    frameRate: 0
                }
            }
        });
        
        let runnerSheets = [], runnersSpr = [], keysSpr = [], keysTexts = [], infoTexts = [{y: 66, t: "Select your runner"},{y: 2, t: "ESC mute music on/off"}];
        let frForSheet = [[0,1,2,3,4,5,6,7], [8,9,10,11,12,13,14,15], [16,17,18,19,20,21,22,23]];
        for (q=0; q<3; q++) {
            frForSheet[q] = (frForSheet[q].splice((RND() * 8)|0, 8)).concat(frForSheet[q]);
            runnerSheets.push(kontra.spriteSheet({
                image: kontra.assets.images.c,
                frameWidth: 16,
                frameHeight: 20,
                animations: {
                    run: {
                        frames: frForSheet[q],
                        frameRate: 20
                    },
                    run_slow: {
                        frames: frForSheet[q],
                        frameRate: 6
                    }
                }
            }));
            let x = ((CW-60)/3*(q+1));
            runnersSpr.push(kontra.sprite({
                x: x,
                y: 106,
                animations: runnerSheets[q].animations
            }));
            
            keysSpr.push(kontra.sprite({
                x: x,
                y: 80,
                animations: keybSheet.animations
            }));
            keysTexts.push({
                x: x+6,
                y: 84,
                t: ["A", "S", "D"][q],
                s: 1.4
            });
        }
        let clouds = [];
        for (q=1; q<3; q++) {
            clouds.push(kontra.sprite({
                x: CW * (1 + RND()),
                y: 6 + CH * (RND() * 0.25),
                image: kontra.assets.images["c"+q],
                dx: -RND(),
                update: function() {
                    if (this.x < -40) {
                        this.x = CW * (1 + RND());
                        this.y = 6 + CH * (RND() * 0.25);
                        this.dx = -RND();
                    }
                    this.advance();
                }
            }));
        }
        
        let rabbitSheet = kontra.spriteSheet({
            image: kontra.assets.images.r,
            frameWidth: 20,
            frameHeight: 20,
            animations: {
                walkL: {
                    frames: "0..5",
                    frameRate: 12
                },
                walkR: {
                    frames: "6..11",
                    frameRate: 12
                },
                idleL: {
                    frames: [2],
                    frameRate: 0
                },
                idleR: {
                    frames: [8],
                    frameRate: 0
                }
            }
        });
        let rabbit = kontra.sprite({
            x: (CW*RND())|0,
            y: 100 + (RND()*10)|0,
            animations: rabbitSheet.animations,
            dt: 0,
            timer: 1 + RND()*1,
            walk: false,
            update: function(dt) {
                this.dt += dt;
                if (this.dt > this.timer) {
                    this.dt = 0;
                    this.timer = 1 + RND()*1;
                    if (!this.walk && RND()<.8) {
                        let x = CW*RND();
                        let y = CH - (20*RND()) - 10;
                        this.dx = x - this.x > 0 ? .5 : -.5;
                        this.dy = y - this.y > 0 ? .1 : -.1;
                        this.playAnimation(this.dx > 0 ? "walkR" : "walkL");
                    } else {
                        this.playAnimation(this.dx > 0 ? "idleR" : "idleL");
                        this.dx = 0;
                        this.dy = 0;
                    }
                    this.x = this.x | 0;
                    this.y = this.y | 0;
                    this.walk = this.walk ? false : true;
                }
                this.advance();
            }
        });
        rabbit.playAnimation("idleL");
        
        kontra.gameLoop({
            update: function(dt) {
                blinkDT += dt;
                if (blinkDT > .4) {
                    blinkDT = 0;
                    blink = !blink;
                }
                
                runnersSpr.map(s=>{
                    s.update();
                });
                keysSpr.map(s=>{
                    s.update();
                });
                if (gameState <= STATE_LAUNCH) {
                    title.update(dt);
                }
                
                if (gameState > STATE_INTRO) {
                    clouds.map(c=>{
                        c.update();
                    });   
                    hero.update();
                    enemy.update();
                    rabbit.update(dt);
                    if (chosenKeySpr) chosenKeySpr.update();
                }
                
                if (gameState == STATE_PLAY && hero.isOffline) {
                    offline.x = hero.x;
                    offline.y = hero.y - 25;
                }
                
                if (gameState == STATE_COUNT) {
                    countdownDT += dt;
                    if (countdownDT >= 1) {
                        if (++countdownPos >= countdownMsg.length) {
                            gameState = STATE_PLAY;
                            generateNextKey();
                            hero.dx = 0.1;
                            enemy.dx = 0.1;
                            infoTexts = [];
                            return;
                        }
                        infoTexts = [{y: 50, t: countdownMsg[countdownPos]}];
                        countdownDT = 0;
                    }
                }
            },
            
            render: function() {
                if (gameState == STATE_INTRO) {
                    runnersSpr.map(s=>{
                        s.render();
                    });
                    keysSpr.map(s=>{
                        s.render();
                    });
                }
                if (gameState > STATE_INTRO) {
                    background.render();
                    clouds.map(c=>{
                        c.render();
                    });
                    enemy.render();
                    hero.render();
                    rabbit.render();
                    if (chosenKeySpr) chosenKeySpr.render();
                }
                
                if (gameState == STATE_PLAY && hero.isOffline) {
                    offline.render();
                }
                
                if (gameState <= STATE_LAUNCH) {
                    title.render();
                }
                if (blink) {
                    ctx.fillStyle = "#fff";
                    infoTexts.map(t=>{
                        drawFontCenter(ctx, t.t, t.y);
                    });
                }
                ctx.fillStyle = "#000";
                keysTexts.map(t=>{
                    drawFont(ctx, t.t, t.x, t.y, t.s);
                });
            }
        }).start();
    }
}

window.addEventListener("load", function() {
    let g = new Game();
}, false);